---
- name: Collect all host IPs and transform into a dictionary
  hosts: all
  gather_facts: true
  tasks:
    - name: Initialize agents_dict as an empty dictionary
      ansible.builtin.set_fact:
        agents_dict: {}

    - name: Append each host's IP to agents_dict with "agentN"
      ansible.builtin.set_fact:
        agents_dict: "{{ agents_dict | combine({ hostvars[item].ansible_host: 'agent' + '%03d' | format(item_index + 1) }) }}"
      with_items: "{{ groups['all'] }}"
      loop_control:
        index_var: item_index  # Provides the index of the current item in the loop

    - name: Display agents_dict
      ansible.builtin.debug:
        var: agents_dict
