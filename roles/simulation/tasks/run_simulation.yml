- name: Wait for simulation API to be available
  ansible.builtin.uri:
    url: "{{ simulation_api_uri }}/api/agents/is-exploring"
    method: GET
    return_content: true
    timeout: 10
  register: simulation_wait_result
  retries: 20
  delay: 5
  until: >-
    (simulation_wait_result.status == 200)
    and (simulation_wait_result.json is defined and (not simulation_wait_result.json.isExploring | default(false) | bool))
  failed_when: false

- name: Prepare database before starting simulations
  ansible.builtin.uri:
    url: "{{ simulation_api_uri }}/api/init"
    method: POST
    status_code: 200

- name: Run simulation for agent {{ repetition_number }}
  ansible.builtin.uri:
    url: "http://{{ item }}:{{ simulation_api_port }}/api/explore"
    method: POST
    status_code: 200
  async: 400
  poll: 0
  loop: "{{ agents_list }}"

- name: Wait for each agents to finish exploring
  ansible.builtin.uri:
    url: "http://{{ item }}:{{ simulation_api_port }}/api/agents/is-exploring"
    method: GET
    return_content: true
  register: explore_result
  retries: 60
  delay: 60
  until: explore_result.json.isExploring == false
  loop: "{{ agents_list }}"
