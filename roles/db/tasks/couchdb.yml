---
- name: Add default variables for CouchDB installation
  tags: db, couchdb, install
  ansible.builtin.include_vars:
    file: ../defaults/couchdb_vars.yml

- name: Install CouchDB on Ubuntu
  tags: db, couchdb, install
  block:
    - name: Install prerequisites for CouchDB
      become: true
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
        update_cache: true
      loop:
        - gnupg ##########
        - curl ##########
        - debconf-utils ##########
    - name: Preconfigure CouchDB
      ansible.builtin.debconf:
        name: couchdb
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: "{{ item.vtype }}"
      loop:
        - { question: "couchdb/bindaddress", value: "0.0.0.0", vtype: "string" }
        - { question: "couchdb/mode", value: "standalone", vtype: "select" }
        - { question: "couchdb/adminpass", value: "{{ couchdb_admin_password }}", vtype: "password" }
        - { question: "couchdb/adminpass_again", value: "{{ couchdb_admin_password }}", vtype: "password" }
        - { question: "couchdb/cookie", value: "{{ couchdb_erl_cookie }}", vtype: "string" }
      become: true
    - name: Add CouchDB GPG key
      ansible.builtin.shell:
        cmd: "curl -fsSL https://couchdb.apache.org/repo/keys.asc | gpg --batch --yes --dearmor -o /usr/share/keyrings/couchdb-archive-keyring.gpg"
      become: true
    # - name: Add CouchDB ppa key
    #   ansible.builtin.apt_key:
    #     url: https://couchdb.apache.org/repo/keys.asc
    #     state: present
    - name: Add CouchDB sources list
      ansible.builtin.apt_repository:
        repo: deb [signed-by=/usr/share/keyrings/couchdb-archive-keyring.gpg] https://apache.jfrog.io/artifactory/couchdb-deb/ {{ ansible_distribution_release }} main
        state: present
      become: true
    - name: Install CouchDB
      ansible.builtin.apt:
        name: couchdb ##########
        state: present
        update_cache: true
      notify: Restart CouchDB
  rescue:
    - name: Fail if CouchDB installation fails
      ansible.builtin.fail:
        msg: "CouchDB installation failed."

- name: Configure Erlang magic cookie
  ansible.builtin.lineinfile:
    path: /opt/couchdb/etc/vm.args
    line: '-setcookie {{ couchdb_erl_cookie }}'
    state: present
    create: true
    owner: couchdb
    group: couchdb
    mode: '0600'
  become: true

- name: Configure CouchDB settings
  tags: db, couchdb, config
  block:
    - name: Copy configuration template for CouchDB
      ansible.builtin.template:
        src: couchdb.ini.j2
        dest: /opt/couchdb/etc/local.ini
        owner: couchdb
        group: couchdb
        mode: '0644'
      become: true
      notify: Restart CouchDB

    - name: Wait for CouchDB to be ready
      ansible.builtin.wait_for:
        host: localhost
        port: 5984
        delay: 5
        timeout: 30

    - name: Save credentials
      set_fact:
        couchdb_credentials: "Basic {{ (couchdb_admin_user + ':' + couchdb_admin_password) | b64encode }}"

    - name: Put v2grid database in CouchDB
      tags: db, couchdb, config
      ansible.builtin.uri:
        url: "http://localhost:5984/v2grid" ####
        method: PUT
        headers:
          Content-Type: application/json
          Authorization: "{{ couchdb_credentials }}"
        status_code: [201, 412]
      register: create_db_result

    - name: Set up replication between CouchDB nodes
      tags: db, couchdb, config
      block:
        - name: Set up replication to peers
          ansible.builtin.uri:
            url: "http://localhost:5984/_replicator"
            method: POST
            headers:
              Content-Type: application/json
              Authorization: "{{ couchdb_credentials }}"
            body_format: json
            body: |
              {
                "source": "http://{{ couchdb_admin_user }}:{{ couchdb_admin_password }}@127.0.0.1:5984/v2grid",
                "target": "http://{{ couchdb_admin_user }}:{{ couchdb_admin_password }}@{{ item }}:5984/v2grid",
                "continuous": true
              }
            status_code: 201
          loop: "{{ db_nodes }}"
      when: db_nodes is defined and db_nodes | length > 0
