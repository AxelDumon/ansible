---
- name: Detect the operating system
  ansible.builtin.set_fact:
    os_family: "{{ ansible_facts['os_family'] }}"
    os_distribution: "{{ ansible_facts['distribution'] }}"
    os_version: "{{ ansible_facts['distribution_version'] }}"

- name: Include OS-specific variables
  ansible.builtin.include_vars:
    file: "{{ item }}"
  with_first_found:
    - "{{ os_family | lower }}.yml"
    - default.yml

- name: Configure SSH for Linux
  ansible.builtin.include_tasks: linux.yml
  when: os_family != "Windows"

- name: Configure SSH for Windows
  ansible.builtin.include_tasks: windows.yml
  when: os_family == "Windows"

- name: Ensure SSHD service is enabled and started
  ansible.builtin.service:
    name: "{{ sshd_service }}"
    state: started
    enabled: true

- name: Ensure SSH key pair exists locally
  ansible.builtin.openssh_keypair:
    path: "{{ ssh_key_path }}"
    type: ed25519
    state: present
  delegate_to: localhost
  run_once: true
  become: false

- name: Ensure the {{ ansible_user }} user's .ssh directory exists
  ansible.builtin.file:
    path: /home/{{ ansible_user }}/.ssh
    state: directory
    mode: '0700'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Copy public key to remote user's authorized_keys
  ansible.builtin.authorized_key:
    user: "{{ ansible_user }}"
    state: present
    key: "{{ lookup('file', ssh_key_path + '.pub') }}"
    manage_dir: false
